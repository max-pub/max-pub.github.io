<style>
	* {
		font-family: Helvetica;
		font-weight: 300;
	}
	main{
		text-align: justify;
		width: 17cm;
		margin: 0 auto;
		font-size: 17px;
		line-height: 1.3; 
	}
	article h1{
		font-size: 24px;
		margin-bottom: 0;
	}
	article h2{
		font-size: 20px;
		margin-top: 10px;
		margin-bottom: 0;
	}
	article p{
		margin: 5px 0 20px 0;
	}
	h1,h2{
		width: 17cm;
		margin: 1cm auto;
	}
	blockquote{
		color: gray;
	}
	a>.year{color: silver;}
	a{text-decoration: none;color: #333;}
	.li{display: block;}
</style>


<script src='https://cdn.rawgit.com/showdownjs/showdown/master/dist/showdown.min.js'></script>

<main></main>
<!-- <h1></h1>
<h2></h2>
<article></article>
 -->


<script>
MD = new showdown.Converter(),
HASH = 0;
MAIN = document.querySelector('main');

// H1 = document.querySelector('h1');
// H2 = document.querySelector('h2');
// CONTENT = document.querySelector('article');



setInterval(()=>{
	if(window.location.hash === HASH) return;
	HASH = window.location.hash;
	update(HASH.substr(1));
},100);


update = function(hash){
	console.log('hash',hash);
	if(hash.includes('/')) loadBook(hash);
	else loadList(hash);
		// https://api.github.com/repos/max-pub/MarkDownBooks/contents/
	// https://raw.githubusercontent.com/max-pub/MarkDownBooks/master/authors/Johann%20Wolfgang%20von%20Goethe/1774%20Die%20Leiden%20des%20jungen%20Werther.md
}
https://raw.githubusercontent.com/OpenDataCollection/Books/master/deutsch/1749%20Johann%20Wolfgang%20von%20Goethe/1774%20Die%20Leiden%20des%20jungen%20Werther.md

loadBook = function(hash){
	fetch('https://raw.githubusercontent.com/OpenDataCollection/Books/master/deutsch/'+hash+'.md')
		.then((response) => response.text())
		.then((text)=> {
			makeBookPage(
				{
					author: hash.split('/')[0].substr(5),
					title: hash.split('/')[1].substr(5),
					text: text
				}
			);
	});

}
makeBookPage = function(book){
    var html     = MD.makeHtml(book.text);
    MAIN.innerHTML = `<h1>${book.title}</h1><h2>${book.author}</h2><article>${html}</article>`;
}

loadList = function(hash){
	fetch('https://api.github.com/repos/OpenDataCollection/Books/contents/deutsch/'+hash)
		.then((response) => response.json())
		.then((json)=>{
			var lst = [];
			json.forEach((item)=>{
				var year = item.name.substr(0,4);
				var name = item.name.substr(5).replace('.md','');
				lst.push({year:year, name:name});
			});
			if(hash) makeBookList(lst);
			else makeAuthorList(lst);
	});

}
makeAuthorList = function(lst){
	console.log(lst);
	MAIN.innerHTML = '<h1>Free Books</h1>';
	lst.forEach((item)=>{
		MAIN.innerHTML += `<a class='li' href="#${item.year+' '+item.name}"> <span class='year'>${item.year}</span> ${item.name}</a>`;   
	});
}
makeBookList = function(lst){
	console.log(lst);
	var authorYear = document.location.hash.substr(1,4);
	var authorName = document.location.hash.substr(6);
	MAIN.innerHTML = `<h1>${authorName}</h1>`;
	lst.forEach((item)=>{
		MAIN.innerHTML += `<a class='li' href="#${authorYear+' '+authorName+'/'+item.year+' '+item.name}"> <span class='year'>${item.year}</span> ${item.name}</a>`;   
	});
}

</script>